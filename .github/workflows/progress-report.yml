name: Weekly Progress Report

on:
  schedule:
    - cron: '0 8 * * 1' # Every Monday at 08:00 UTC
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: write
  issues: read
  pull-requests: read

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to fetch all history

      - name: Get commit hashes for the last 7 days
        id: get_commits
        run: |
          # Get the commit hash from 7 days ago. Use the first commit if the repo is less than 7 days old.
          FROM_COMMIT=$(git rev-list -n 1 --before="7 days ago" ${{ github.ref_name }} || git rev-list --max-parents=0 HEAD)
          TO_COMMIT=$(git rev-parse HEAD)
          echo "Generating report from commit $FROM_COMMIT to $TO_COMMIT"
          echo "from_commit=$FROM_COMMIT" >> $GITHUB_OUTPUT
          echo "to_commit=$TO_COMMIT" >> $GITHUB_OUTPUT

      - name: Generate progress report
        uses: janheinrichmerker/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output: PROGRESS.md
          since-tag: ${{ steps.get_commits.outputs.from_commit }}
          due-tag: ${{ steps.get_commits.outputs.to_commit }}
          header-label: "# Weekly Progress Report"
          pr-label: "## Merged Pull Requests"
          issues-label: "## Closed Issues"
          # The generator automatically adds a contributors section at the end.
          # The prompt's "new contributors" is an "if possible" item, and this is a good approximation.

      - name: Commit progress report
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update weekly progress report [skip ci]"
          file_pattern: PROGRESS.md
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
